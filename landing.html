<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#000000" />
  <title>DexTracker ‚Äî Smarter YouTube Growth</title>

  <!-- fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{ --bg:#000; --bg2:#0b140b; --fg:#e7ffe7; --acid:#12ff6d; --grid:#083108; --muted:#9cf5c9; --card:#0c160d; --line:#124b22; --glass:rgba(0,0,0,.55) }
    *{box-sizing:border-box} html,body{height:100%} html{scroll-behavior:smooth}
    body{
      margin:0; color:var(--fg);
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background:
        radial-gradient(1200px 800px at 10% -10%, #051505 0%, var(--bg) 55%),
        radial-gradient(1200px 800px at 90% 110%, #051505 0%, var(--bg) 55%);
    }

    /* NAV */
    .nav{
      position:sticky; top:0; z-index:1000; inset-inline:0;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px clamp(16px,4vw,28px);
      background:linear-gradient(to bottom, rgba(0,0,0,.85), rgba(0,0,0,.55));
      backdrop-filter:saturate(140%) blur(10px);
      border-bottom:1px solid var(--line);
    }
    .brand{display:flex; gap:10px; align-items:center; font-family:Orbitron, sans-serif; letter-spacing:.5px}
    .logo{width:28px; aspect-ratio:1; border-radius:6px; background:conic-gradient(from 90deg, #00ff95, #00c853, #00ff95); box-shadow:0 0 20px #00ff95aa inset, 0 0 20px #00ff95aa}
    .brand b{color:var(--acid)}
    .nav a{color:var(--muted); text-decoration:none; font-weight:600; margin:0 10px; padding:8px 10px; border-radius:8px; transition:color .15s, background .15s}
    .nav a:hover{color:var(--fg); background:rgba(18,255,109,.08)}
    .nav a.active{color:#001a0e; background:var(--acid)}
    .burger{display:none; flex-direction:column; gap:4px; cursor:pointer}
    .burger span{width:24px; height:2px; background:var(--fg);}
    .links{display:flex; align-items:center}
    @media (max-width:860px){
      .burger{display:flex}
      .links{position:fixed; right:16px; top:64px; background:var(--glass); backdrop-filter:blur(16px); padding:12px; border:1px solid var(--line); border-radius:12px; display:none; flex-direction:column}
      .links a{display:block; width:100%; text-align:left; margin:4px 0}
      .links.open{display:flex}
    }

    /* HERO */
    .hero{
      min-height:96svh; display:grid; place-items:center; text-align:center; position:relative; overflow:hidden;
      background: linear-gradient(to bottom, rgba(0,0,0,.6), rgba(0,0,0,.9)), url('https://images.unsplash.com/photo-1527443154391-507e9dc6c5cc?q=80&w=1600&auto=format&fit=crop') center/cover no-repeat fixed;
      border-bottom:1px solid var(--line);
    }
    .hero h1{font-family:Orbitron, sans-serif; font-size: clamp(32px, 5vw, 68px); margin:0 0 12px; color:var(--acid); text-shadow:0 0 30px #00ff95aa}
    .hero p{max-width:min(780px, 90vw); margin:0 auto 24px; font-size:clamp(16px, 1.6vw, 20px); color:#c9ffd6}
    .cta{display:inline-flex; align-items:center; gap:10px; padding:12px 18px; border-radius:12px; font-weight:800; text-decoration:none; color:#001a0e; background:var(--acid); box-shadow:0 0 24px #00ff9580; border:1px solid #7bffc1}
    .subcta{display:inline-flex; margin-left:10px; color:var(--muted)}
    .tools-btn{display:inline-flex; margin-left:10px; color:#001a0e; background:transparent; border:1px solid #7bffc1; padding:12px 18px; border-radius:12px; font-weight:800; text-decoration:none; background:rgba(18,255,109,.15)}
    .tools-btn:hover{background:rgba(18,255,109,.25)}

    /* TICKER */
    .ticker{position:relative; overflow:hidden; border-block:1px solid var(--line); background:#031a0b}
    .ticker__row{display:flex; gap:40px; white-space:nowrap; padding:8px 0; animation:ticker 28s linear infinite}
    .chip{border:1px solid var(--line); background:#061e10; color:#9cf5c9; padding:6px 10px; border-radius:999px}
    @keyframes ticker{from{transform:translateX(0)} to{transform:translateX(-50%)}}

    /* SECTIONS */
    section{padding: clamp(48px, 9vw, 110px) clamp(16px, 5vw, 28px); max-width:1200px; margin-inline:auto}
    .eyebrow{color:var(--muted); letter-spacing:.18em; text-transform:uppercase; font-weight:800; font-size:12px}
    h2{font-family:Orbitron, sans-serif; color:var(--acid); margin:.25rem 0 1rem; font-size: clamp(26px, 3.2vw, 42px)}
    .lead{color:#c7f6dd; max-width:880px}
    .grid{display:grid; gap:18px}
    .grid.cols-3{grid-template-columns:repeat(3, 1fr)}
    .grid.cols-2{grid-template-columns:repeat(2, 1fr)}
    @media (max-width:980px){.grid.cols-3{grid-template-columns:1fr 1fr}}
    @media (max-width:680px){.grid.cols-3,.grid.cols-2{grid-template-columns:1fr}}

    .card{background: linear-gradient(180deg, rgba(10,18,12,.9), rgba(6,12,8,.9)); border:1px solid var(--line); padding:20px; border-radius:14px; position:relative; overflow:hidden}
    .card:before{content:""; position:absolute; inset:-1px; border-radius:14px; background:radial-gradient(500px 140px at var(--x, 10%) var(--y, 0%), #0bff8a22, transparent 40%); pointer-events:none}
    .card h3{margin:.3rem 0 .6rem; color:#b9ffd8}
    .card p{color:#cdeedb}

    /* Pricing */
    .pricing{display:grid; grid-template-columns:repeat(auto-fit, minmax(260px, 1fr)); gap:18px}
    .price{font-size:32px; font-weight:800; color:var(--acid)}

    /* Gallery */
    .gallery{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
    .tile{position:relative; border-radius:14px; overflow:hidden; border:1px solid var(--line)}
    .tile img{display:block; width:100%; height:100%; object-fit:cover; aspect-ratio:4/3; filter:saturate(0.8) contrast(1.05)}
    .tile .overlay{position:absolute; inset:0; background:linear-gradient(to top, rgba(0,0,0,.75), transparent 60%); display:flex; align-items:flex-end; padding:12px; font-weight:700}

    /* FAQ */
    details{border:1px solid var(--line); border-radius:12px; padding:14px 16px; background:#07140a}
    details+details{margin-top:10px}
    summary{cursor:pointer; font-weight:700; color:#b8ffd7}
    details p{color:#dff7ea}

    /* Footer */
    footer{border-top:1px solid var(--line); background:#030a06; padding:28px; text-align:center; color:var(--muted)}
    footer a{color:var(--acid); text-decoration:none}

    /* Reveal animations */
    .reveal{opacity:0; transform:translateY(16px); transition:opacity .6s ease, transform .6s ease}
    .reveal.in{opacity:1; transform:none}

    /* TOOLS SECTION */
    .tools{ background:linear-gradient(180deg, rgba(6,12,8,.85), rgba(3,10,6,.85)); border:1px solid var(--line); border-radius:14px; padding:20px; }
    .tools-row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .tools input{
      flex:1; min-width:260px; background:#0b140b; color:#e7ffe7;
      border:1px solid var(--line); border-radius:10px; padding:12px 14px; outline:none;
      pointer-events:auto; -webkit-tap-highlight-color: transparent;
    }
    .btn{
      display:inline-flex; align-items:center; gap:8px; padding:12px 14px; border-radius:10px;
      border:1px solid #7bffc1; background:var(--acid); color:#001a0e; font-weight:800; text-decoration:none;
      cursor:pointer; pointer-events:auto; -webkit-tap-highlight-color: transparent;
    }
    .btn.secondary{background:transparent; color:var(--muted); border-color:var(--line);}

    /* Tool Progress UI */
    .progress-wrap{margin-top:12px}
    .progress-bar{ width:100%; height:10px; border-radius:999px; background:#06210f; border:1px solid var(--line); overflow:hidden }
    .progress-fill{ height:100%; width:0%; background:var(--acid); transition:width .25s ease; }
    .status{color:#cdeedb; font-size:13px; margin-top:6px}
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="nav" id="nav">
    <div class="brand"><span class="logo"></span><span>DexTracker <b>Ai</b></span></div>
    <div class="burger" id="burger" aria-label="Toggle navigation" aria-expanded="false" aria-controls="navlinks">
      <span></span><span></span><span></span>
    </div>
    <div class="links" id="navlinks">
      <a href="#home" data-link>Home</a>
      <a href="#features" data-link>Features</a>
      <a href="#how" data-link>How It Works</a>
      <a href="#gallery" data-link>Gallery</a>
      <a href="#pricing" data-link>Pricing</a>
      <a href="#tools" data-link>Tools</a>
      <a href="#faq" data-link>FAQ</a>
    </div>
  </nav>

  <!-- HERO -->
  <header class="hero" id="home">
    <div>
      <h1>Unlock Ridiculous Momentum</h1>
      <p id="hero-copy">Hacker-clean analytics, clip candidates, and retention-spike helpers so you post smarter and grow faster.</p>
      <a class="cta" href="#pricing" data-link>Start Free Trial ‚Üí</a>
      <a class="subcta" href="#features" data-link>See how it works</a>
      <a class="tools-btn" href="#tools" data-link>Tools</a>
    </div>
  </header>

  <!-- TICKER -->
  <div class="ticker" aria-hidden="true">
    <div class="ticker__row">
      <span class="chip">Live CTR titles</span>
      <span class="chip">Retention spike alerts</span>
      <span class="chip">Script Brainstormer</span>
      <span class="chip">AI reply queue</span>
      <span class="chip">Hacker UI</span>
      <span class="chip">DexClanTv verified</span>
      <span class="chip">Live CTR titles</span>
      <span class="chip">Retention spike alerts</span>
      <span class="chip">Script Brainstormer</span>
      <span class="chip">AI reply queue</span>
      <span class="chip">Hacker UI</span>
      <span class="chip">DexClanTv verified</span>
    </div>
  </div>

  <!-- FEATURES -->
  <section id="features">
    <span class="eyebrow">Capabilities</span>
    <h2>Everything you need to win the upload war</h2>
    <p class="lead">Jet-black UI + neon clarity for creators who ship.</p>
    <div class="grid cols-3">
      <div class="card reveal"><h3>üîÅ Clip Candidates</h3><p>Surface spike windows and one-tap exports for Shorts/Reels/TikTok.</p></div>
      <div class="card reveal"><h3>üß† Script Brainstormer</h3><p>Full script drafts tuned to <em>your</em> tone + SEO-aware title ideas.</p></div>
      <div class="card reveal"><h3>üìà Live Analytics</h3><p>CTR, impressions, and retention in one glance.</p></div>
      <div class="card reveal"><h3>ü§ñ Reply Queue</h3><p>Pull recent comments, propose replies; you approve.</p></div>
      <div class="card reveal"><h3>üîî Smart Alerts</h3><p>Notify on dips/spikes and suggest iterations.</p></div>
      <div class="card reveal"><h3>üõ°Ô∏è Privacy-First</h3><p>Local secrets + transparent scopes. You‚Äôre in control.</p></div>
    </div>
  </section>

  <!-- HOW -->
  <section id="how">
    <span class="eyebrow">Workflow</span>
    <h2>Three steps. All gas, no brakes.</h2>
    <div class="grid cols-3">
      <div class="card reveal"><h3>1) Set Intent</h3><p>Tailor dashboards and alerts to your goals.</p></div>
      <div class="card reveal"><h3>2) Leverage AI</h3><p>Brainstorm scripts, simulate titles, and queue clips.</p></div>
      <div class="card reveal"><h3>3) React Fast</h3><p>Push notifications flag dips/spikes so you iterate faster.</p></div>
    </div>
  </section>

  <!-- GALLERY -->
  <section id="gallery">
    <span class="eyebrow">Interface</span>
    <h2>Looks cold. Works hot.</h2>
    <p class="lead">Neon-glass tiles meet hacker-clean signal.</p>
    <div class="gallery">
      <div class="tile reveal"><img alt="CTR Heatmap" src="https://images.unsplash.com/photo-1551281044-8b4c1b7e4d5f?q=80&w=1200&auto=format&fit=crop"><div class="overlay">CTR Heatmaps</div></div>
      <div class="tile reveal"><img alt="Retention Chart" src="https://images.unsplash.com/photo-1520607162513-77705c0f0d4a?q=80&w=1200&auto=format&fit=crop"><div class="overlay">Retention Curves</div></div>
      <div class="tile reveal"><img alt="AI Brainstorm" src="https://images.unsplash.com/photo-1504384308090-c894fdcc538d?q=80&w=1200&auto=format&fit=crop"><div class="overlay">AI Brainstorm</div></div>
    </div>
  </section>

  <!-- PRICING -->
  <section id="pricing">
    <span class="eyebrow">Plans</span>
    <h2>Simple pricing. 7-day free trial.</h2>
    <div class="pricing">
      <div class="card reveal"><h3>Pro</h3><p class="price">$9.99<span style="font-size:16px">/mo</span></p><p>All premium features ‚Ä¢ Daily analytics ‚Ä¢ Alerts ‚Ä¢ AI replies</p><p><a class="cta" href="#" onclick="alert('Coming soon ‚Ä¢ App Store connect')">Get Pro</a></p></div>
      <div class="card reveal"><h3>Elite</h3><p class="price">$49.99<span style="font-size:16px">/yr</span></p><p>Everything in Pro ‚Ä¢ Annual savings ‚Ä¢ Early access experiments</p><p><a class="cta" href="#" onclick="alert('Coming soon ‚Ä¢ App Store connect')">Go Elite</a></p></div>
    </div>
  </section>

  <!-- TOOLS -->
  <section id="tools">
    <span class="eyebrow">Utilities</span>
    <h2>Tools</h2>
    <p class="lead" id="tools-copy">Paste a direct MP4 / M3U8 link you own and we‚Äôll generate clip candidates.</p>

    <div class="tools">
      <div class="tools-row" style="margin-bottom:10px">
        <input id="repurpose-input" type="url" placeholder="Paste direct .mp4 / .m3u8 URL you own" />
        <button id="repurpose-run" class="btn" type="button">Generate Clips</button>
        <button id="clear-input" class="btn secondary" type="button">Clear</button>
        <button id="simulate-progress" class="btn secondary" type="button" title="Test app progress bridge">Simulate Progress</button>
        <button id="simulate-result" class="btn secondary" type="button" title="Test app result bridge">Simulate Result</button>
      </div>

      <!-- Format Picker Row -->
      <div class="tools-row" style="margin-bottom:10px">
        <button id="list-formats" class="btn secondary" type="button">List Formats</button>
        <select id="format-select" style="min-width:260px; flex:1; background:#0b140b; color:#e7ffe7; border:1px solid var(--line); border-radius:10px; padding:10px; display:none">
          <option value="">‚Äî choose a format ‚Äî</option>
        </select>
        <button id="download-format" class="btn secondary" type="button" style="display:none">Download Selected</button>
        <button id="get-mp3" class="btn secondary" type="button" title="Extract audio as MP3">Get MP3</button>
      </div>

      <div class="progress-wrap" id="progress-wrap" style="display:none">
        <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
        <div id="status" class="status"></div>
      </div>

      <div id="tool-result" style="margin-top:16px; display:none"></div>
    </div>
  </section>

  <!-- FAQ -->
  <section id="faq">
    <span class="eyebrow">FAQ</span>
    <h2>Quick answers</h2>
    <details class="reveal"><summary>What is DexTracker?</summary><p>An AI-assisted toolkit for ideation, analysis, and faster shipping‚Äîprivacy-first.</p></details>
    <details class="reveal"><summary>Do you track me?</summary><p>No tracking pixels. We only process links you submit.</p></details>
  </section>

  <footer>
    <div>¬© 2025 DexTracker ‚Ä¢ <a href="https://dexclantv.github.io/landing.html" target="_blank" rel="noopener">GitHub Pages</a></div>
    <div style="margin-top:6px">Follow: <a href="https://www.instagram.com/Perry.Glo" target="_blank" rel="noopener">Instagram</a> ‚Ä¢ <a href="https://twitter.com/DexClanTv" target="_blank" rel="noopener">Twitter</a> ‚Ä¢ <a href="https://www.youtube.com/@DexClanTv" target="_blank" rel="noopener">YouTube</a></div>
    <div style="margin-top:10px; font-size:12px; color:#9cf5c9">
      Privacy: No tracking pixels. We only use the URLs you provide to generate results.
    </div>
  </footer>

  <!-- Bridge helpers (always available) -->
  <script src="minimal.js" defer></script>

  <!-- Page logic -->
  <script>
    // Allow ?api= override for local/tunnel testing
    const API_BASE =
      new URLSearchParams(location.search).get("api") ||
      "https://dextracker-clips.fly.dev";

    // Small helpers
    function showProgressUI(show){
      const wrap = document.getElementById('progress-wrap');
      if(!wrap) return;
      wrap.style.display = show ? 'block' : 'none';
    }
    function setProgress(pct, text){
      const fill = document.getElementById('progress-fill');
      const status = document.getElementById('status');
      if(fill){ fill.style.width = Math.max(0, Math.min(100, pct)) + '%'; }
      if(status){ status.textContent = text || ''; }
    }
    function bindTap(id, handler){
      const el = document.getElementById(id);
      if(!el) return;
      let fired = false;
      const wrap = (e) => {
        if (fired) return;
        fired = true;
        try { handler(e); } finally { setTimeout(()=>fired=false, 120); }
      };
      el.addEventListener('click', wrap, { passive: true });
      el.addEventListener('touchend', wrap, { passive: true });
    }

    // ===== Format parsing (client-side) =====
    // Parses yt-dlp "-F" output text into [{id, ext, res, fps, vcodec, acodec, size, note}]
    function parseFormats(text){
      const lines = (text || "").split("\n");
      const rows = [];
      for (const ln of lines){
        const m = ln.match(/^\s*([0-9a-zA-Z.-]+)\s+(\S+)\s+(.+?)\s{2,}(.+)?$/);
        if (!m) continue;
        const id = m[1];
        const ext = m[2];
        const col3 = m[3];
        const rest = (m[4]||"").trim();

        let res = "", fps = "", vcodec="", acodec="", size="";
        if (/audio only/i.test(col3)){
          res = "audio";
        } else {
          const r1 = col3.match(/(\d{3,4}x\d{3,4})/);
          const r2 = col3.match(/(\d{3,4}p)/i);
          res = r1 ? r1[1] : (r2 ? r2[1] : col3.trim());
        }
        const fpsm = rest.match(/(\d{2,3})fps/);
        fps = fpsm ? fpsm[1] : "";
        const vc = rest.match(/vcodec\s+([^\s,]+)/i);
        if (vc) vcodec = vc[1];
        const ac = rest.match(/acodec\s+([^\s,]+)/i);
        if (ac) acodec = ac[1];
        const sz = rest.match(/(\d+(?:\.\d+)?[MK]B)/i);
        if (sz) size = sz[1];

        rows.push({ id, ext, res, fps, vcodec, acodec, size, note: rest });
      }
      const seen = new Set();
      return rows.filter(r=>{
        const key = r.id+"|"+r.ext+"|"+r.res+"|"+r.fps;
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });
    }

    // Populate <select> with human-friendly labels (tags audio)
    function fillFormatSelect(rows){
      const sel = document.getElementById("format-select");
      const btn = document.getElementById("download-format");
      if (!sel) return;
      sel.innerHTML = `<option value="">‚Äî choose a format ‚Äî</option>`;

      rows.forEach(r=>{
        const isAudio = (r.res || "").toLowerCase() === "audio" || /audio only/i.test(r.note||"");
        const label = [
          r.id,
          r.ext?.toUpperCase(),
          isAudio ? "AUDIO" : (r.res || ""),
          r.fps ? `${r.fps}fps` : "",
          r.size ? `(${r.size})` : "",
          (r.vcodec && r.acodec) ? `${r.vcodec}+${r.acodec}` : (r.vcodec || r.acodec || "")
        ].filter(Boolean).join(" ¬∑ ");

        const opt = document.createElement("option");
        opt.value = r.id;
        opt.textContent = label;
        opt.dataset.isAudio = isAudio ? "1" : "0";
        sel.appendChild(opt);
      });

      sel.style.display = "block";
      btn.style.display = "inline-flex";
    }

    // Job poller shared
    async function pollJob(jobId){
      return new Promise((resolve, reject)=>{
        let last = 10;
        async function tick(){
          try{
            const r = await fetch(`${API_BASE}/api/jobs/${jobId}`);
            const data = await r.json();
            if (data.status === "running"){
              last = Math.max(last, Math.round((data.progress||0)*100));
              setProgress(last, `Processing‚Ä¶ ${last}%`);
              setTimeout(tick, 900);
            } else if (data.status === "done" && data.url){
              setProgress(100, "Finished!");
              resolve(`${API_BASE}${data.url}`);
            } else if (data.status === "error"){
              reject(new Error(data.error || "merge error"));
            } else {
              setTimeout(tick, 1200);
            }
          } catch {
            setTimeout(tick, 1200);
          }
        }
        tick();
      });
    }

    // ===== Buttons wiring =====
    bindTap('repurpose-run', async () => {
      const input = document.getElementById('repurpose-input');
      const val = input?.value?.trim();
      if(!val){ alert('Paste a direct .mp4/.m3u8 URL you own.'); return; }

      showProgressUI(true);
      setProgress(5, 'Contacting Clip API‚Ä¶');
      sendProgress(0.05);

      try {
        const r = await fetch(`${API_BASE}/api/clip`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url: val })
        });

        if (r.status === 403) throw new Error(await r.text());

        // Fallback to merge
        if (r.status === 409) {
          setProgress(10, 'No single stream. Merging‚Ä¶');
          const r2 = await fetch(`${API_BASE}/api/jobs`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: val })
          });
          if (!r2.ok) throw new Error(await r2.text() || `HTTP ${r2.status}`);
          const { jobId } = await r2.json();
          const fileUrl = await pollJob(jobId);
          const el = document.getElementById('tool-result');
          el.style.display = 'block';
          el.innerHTML = `<div class="card"><h3>Result</h3><p><a href="${fileUrl}" target="_blank" rel="noopener">Download MP4</a></p></div>`;
          return;
        }

        if (!r.ok) throw new Error(await r.text() || `HTTP ${r.status}`);

        const data = await r.json();
        if (!data.directUrl) throw new Error('No directUrl returned');
        setProgress(20, 'Fetching media‚Ä¶');
        sendResult(data.directUrl);

        const result = document.getElementById('tool-result');
        result.style.display = 'block';
        result.innerHTML = `<div class="card" style="margin-top:8px">
          <h3>Result</h3>
          <p>Sent final clip URL to the app.</p>
          <p>Fallback link: <a href="${data.directUrl}" target="_blank" rel="noopener">open</a></p>
        </div>`;
        setProgress(100, 'Finished!');
        sendProgress(1.0);
      } catch (e) {
        console.error(e);
        setProgress(0, 'Error: ' + (e?.message || e));
        alert('Clip API failed: ' + (e?.message || e));
        sendProgress(0.0);
      }
    });

    // List Formats
    bindTap('list-formats', async ()=>{
      const input = document.getElementById('repurpose-input');
      const val = input?.value?.trim();
      if(!val){ return alert("Paste a URL first."); }
      showProgressUI(true);
      setProgress(8, "Listing formats‚Ä¶");
      try{
        const r = await fetch(`${API_BASE}/api/vb/formats`, {
          method: "POST",
          headers: {"content-type":"application/json"},
          body: JSON.stringify({ url: val })
        });
        if (!r.ok) throw new Error(await r.text() || `HTTP ${r.status}`);
        const data = await r.json();
        const rows = parseFormats(data.formats || "");
        if (!rows.length) throw new Error("No formats found.");
        fillFormatSelect(rows);
        setProgress(12, "Choose a format then Download Selected");
      }catch(e){
        alert("Formats failed: " + (e.message || e));
        setProgress(0, "Error");
      }
    });

    // Download Selected format (auto-upgrade video-only ‚Üí +bestaudio)
    bindTap('download-format', async ()=>{
      const input = document.getElementById('repurpose-input');
      const url = input?.value?.trim();
      const sel = document.getElementById('format-select');
      let format = sel?.value?.trim();
      if (!url) return alert("Paste a URL first.");
      if (!format) return alert("Choose a format first.");

      const isAudioOnly = sel.options[sel.selectedIndex]?.dataset?.isAudio === "1";
      if (!isAudioOnly && !format.includes("+")) {
        format = `${format}+bestaudio/b`;
      }

      showProgressUI(true);
      setProgress(10, `Downloading ${format}‚Ä¶`);

      try{
        const r = await fetch(`${API_BASE}/api/clip`, {
          method: "POST",
          headers: {"content-type":"application/json"},
          body: JSON.stringify({ url, format })
        });

        if (r.status === 403) throw new Error(await r.text());

        if (r.status === 409) {
          const r2 = await fetch(`${API_BASE}/api/jobs`, {
            method: "POST",
            headers: {"content-type":"application/json"},
            body: JSON.stringify({ url, format })
          });
          if (!r2.ok) throw new Error(await r2.text() || `HTTP ${r2.status}`);
          const { jobId } = await r2.json();
          const fileUrl = await pollJob(jobId);
          const el = document.getElementById('tool-result');
          el.style.display = 'block';
          el.innerHTML = `<div class="card"><h3>Result</h3><p><a href="${fileUrl}" target="_blank" rel="noopener">Download MP4</a></p></div>`;
          return;
        }

        if (!r.ok) throw new Error(await r.text() || `HTTP ${r.status}`);
        const data = await r.json();
        if (!data.directUrl) throw new Error("No directUrl returned");
        setProgress(20, "Fetching media‚Ä¶");
        sendResult(data.directUrl);
        const el = document.getElementById('tool-result');
        el.style.display = 'block';
        el.innerHTML = `<div class="card"><h3>Result</h3>
          <p>Sent final clip URL to the app. Fallback: <a href="${data.directUrl}" target="_blank" rel="noopener">open</a></p></div>`;
        setProgress(100, "Finished!");
      }catch(e){
        alert("Download failed: " + (e.message || e));
        setProgress(0, "Error");
      }
    });

    // MP3
    bindTap("get-mp3", async ()=>{
      const input = document.getElementById('repurpose-input');
      const url = input?.value?.trim();
      if(!url) return alert("Paste a URL first.");
      showProgressUI(true);
      setProgress(10, "Extracting audio‚Ä¶");
      try{
        const r = await fetch(`${API_BASE}/api/mp3`, {
          method: "POST",
          headers: {"content-type":"application/json"},
          body: JSON.stringify({ url })
        });
        if (!r.ok) throw new Error(await r.text() || `HTTP ${r.status}`);
        const { jobId } = await r.json();
        const fileUrl = await pollJob(jobId);
        window.open(fileUrl, "_blank", "noopener");
      }catch(e){
        alert("MP3 API failed: " + (e.message || e));
        setProgress(0, "Error");
      }
    });

    // Mobile nav + reveals
    const burger = document.getElementById('burger');
    const links = document.getElementById('navlinks');
    burger?.addEventListener('click', () => {
      const open = links.classList.toggle('open');
      burger.setAttribute('aria-expanded', open ? 'true':'false');
    });
    function scrollToWithOffset(id){
      const el = document.querySelector(id);
      const nav = document.getElementById('nav');
      if(!el || !nav) return;
      const y = el.getBoundingClientRect().top + window.scrollY - (nav.offsetHeight + 8);
      window.scrollTo({top:y, behavior:'smooth'});
    }
    document.querySelectorAll('[data-link]')?.forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        scrollToWithOffset(a.getAttribute('href'));
        links.classList.remove('open');
      });
    });
    const sections = [...document.querySelectorAll('header[id], section[id]')];
    const navLinks = [...document.querySelectorAll('.links a[data-link]')];
    const byId = id => navLinks.find(a=>a.getAttribute('href')==="#"+id);
    const spy = new IntersectionObserver(entries=>{
      entries.forEach(({isIntersecting, target})=>{
        if(isIntersecting){
          navLinks.forEach(n=>n.classList.remove('active'));
          byId(target.id)?.classList.add('active');
        }
      })
    },{rootMargin:'-40% 0px -55% 0px', threshold:[0, .2, .6, 1]});
    sections.forEach(s=>spy.observe(s));
    document.querySelectorAll('.card').forEach(card=>{
      card.addEventListener('pointermove', e=>{
        const r = card.getBoundingClientRect();
        card.style.setProperty('--x', ((e.clientX-r.left)/r.width*100)+'%');
        card.style.setProperty('--y', ((e.clientY-r.top)/r.height*100)+'%');
      })
    });
    const revealer = new IntersectionObserver((entries)=>{
      entries.forEach(({isIntersecting, target})=>{
        if(isIntersecting){ target.classList.add('in'); revealer.unobserve(target); }
      })
    },{threshold:.12});
    document.querySelectorAll('.reveal').forEach(n=>revealer.observe(n));

    // Clear
    bindTap('clear-input', () => {
      const input = document.getElementById('repurpose-input');
      const result = document.getElementById('tool-result');
      const sel = document.getElementById('format-select');
      const dl = document.getElementById('download-format');
      if(input) input.value = '';
      if(result){ result.style.display = 'none'; result.innerHTML = ''; }
      if(sel){ sel.style.display = 'none'; sel.innerHTML = `<option value="">‚Äî choose a format ‚Äî</option>`; }
      if(dl){ dl.style.display = 'none'; }
      showProgressUI(false);
      setProgress(0, '');
      sendProgress(0.0);
    });

    // Demo buttons
    bindTap('simulate-progress', () => {
      showProgressUI(true);
      let p = 0;
      const id = setInterval(()=>{
        p = Math.min(1, p + 0.06);
        setProgress(Math.round(p*100), `Analyzing / clipping‚Ä¶ ${Math.round(p*100)}%`);
        sendProgress(p);
        if (p >= 1) clearInterval(id);
      }, 300);
    });
    bindTap('simulate-result', () => {
      const demo = 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4';
      sendResult(demo);
      const result = document.getElementById('tool-result');
      if(result){
        result.style.display = 'block';
        result.innerHTML = `<div class="card" style="margin-top:8px">
          <h3>Result</h3>
          <p>Sent final clip URL to the app. Fallback link: <a href="${demo}" target="_blank" rel="noopener">open</a></p>
        </div>`;
      }
      setProgress(100, 'Finished!');
    });
  </script>
</body>
</html>
