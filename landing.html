<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#000000" />
  <title>DexTracker â€” Smarter YouTube Growth</title>

  <!-- fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#000;
      --bg2:#0b140b;
      --fg:#e7ffe7;
      --acid:#12ff6d;
      --acid-soft:rgba(18,255,109,.15);
      --grid:#083108;
      --muted:#9cf5c9;
      --card:#0c160d;
      --line:#124b22;
      --glass:rgba(0,0,0,.55);
      --danger:#ff4d4f;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html{scroll-behavior:smooth}
    body{
      margin:0; color:var(--fg);
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background:
        radial-gradient(1100px 760px at 15% -10%, #051505 0%, var(--bg) 55%),
        radial-gradient(1100px 760px at 90% 110%, #051505 0%, var(--bg) 55%);
    }

    /* NAV */
    .nav{
      position:sticky; top:0; z-index:1000; inset-inline:0;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px clamp(16px,4vw,28px);
      background:linear-gradient(to bottom, rgba(0,0,0,.85), rgba(0,0,0,.15));
      backdrop-filter:saturate(140%) blur(10px);
      border-bottom:1px solid rgba(18,255,109,.08);
    }
    .brand{display:flex; gap:10px; align-items:center; font-family:Orbitron, sans-serif; letter-spacing:.5px}
    .logo{
      width:30px; aspect-ratio:1; border-radius:8px;
      background:conic-gradient(from 90deg, #00ff95, #00c853, #00ff95);
      box-shadow:0 0 20px #00ff95aa inset, 0 0 20px #00ff95aa;
    }
    .brand b{color:var(--acid)}
    .nav a{
      color:var(--muted); text-decoration:none; font-weight:600;
      margin:0 6px; padding:8px 12px; border-radius:10px;
      transition:color .15s, background .15s, transform .15s;
    }
    .nav a:hover{color:var(--fg); background:rgba(18,255,109,.08); transform:translateY(-1px)}
    .nav a.active{color:#001a0e; background:var(--acid)}
    .burger{display:none; flex-direction:column; gap:4px; cursor:pointer}
    .burger span{width:24px; height:2px; background:var(--fg);}
    .links{display:flex; align-items:center}
    @media (max-width:880px){
      .burger{display:flex}
      .links{
        position:fixed; right:16px; top:64px; background:var(--glass);
        backdrop-filter:blur(16px); padding:12px; border:1px solid var(--line); border-radius:12px;
        display:none; flex-direction:column; min-width:180px;
      }
      .links a{display:block; width:100%; text-align:left; margin:4px 0}
      .links.open{display:flex}
    }

    /* HERO */
    .hero{
      min-height:90vh; display:grid;
      grid-template-columns:1.05fr .95fr;
      gap:32px;
      align-items:center;
      padding: clamp(30px, 6vw, 46px) clamp(16px, 5vw, 28px);
      border-bottom:1px solid rgba(18,255,109,.03);
    }
    .hero-text{
      max-width:580px;
      animation:fadeUp .6s ease .1s both;
    }
    .eyebrow{
      color:var(--muted); letter-spacing:.18em; text-transform:uppercase; font-weight:800; font-size:12px;
    }
    .hero h1{
      font-family:Orbitron, sans-serif;
      font-size: clamp(34px, 4.5vw, 62px);
      margin:.25rem 0 .4rem;
      color:var(--acid);
      text-shadow:0 0 35px rgba(0,255,149,.35);
      line-height:1;
    }
    .hero p{
      color:#c9ffd6;
      font-size:clamp(15px, 1.5vw, 18px);
      margin-bottom:20px;
    }
    .hero-actions{
      display:flex; flex-wrap:wrap; gap:12px;
    }
    .btn-primary, .btn-ghost{
      display:inline-flex; align-items:center; gap:8px;
      border-radius:14px;
      font-weight:700; text-decoration:none;
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
      cursor:pointer;
    }
    .btn-primary{
      background:var(--acid);
      color:#001a0e;
      padding:12px 20px;
      box-shadow:0 14px 40px rgba(0,255,149,.35);
    }
    .btn-primary:hover{transform:translateY(-1px); box-shadow:0 18px 45px rgba(0,255,149,.35);}
    .btn-ghost{
      background:rgba(18,255,109,.00);
      border:1px solid rgba(124,255,196,.35);
      color:var(--fg);
      padding:11px 17px;
      backdrop-filter:blur(10px);
    }
    .btn-ghost:hover{background:rgba(18,255,109,.08);}
    @media (max-width:980px){
      .hero{grid-template-columns:1fr; padding-top:76px;}
    }

    /* HERO VIDEO CARD */
    .hero-video{
      position:relative;
      border:1px solid rgba(18,255,109,.12);
      background:radial-gradient(circle at 10% 10%, rgba(18,255,109,.15), rgba(0,0,0,0));
      border-radius:22px;
      overflow:hidden;
      min-height:250px;
      display:flex;
      align-items:center;
      justify-content:center;
      animation:fadeInRight .7s ease .25s both;
    }
    .hero-video video{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .glow-ring{
      position:absolute;
      inset:-20% -5%;
      background:radial-gradient(circle, rgba(18,255,109,.25), rgba(18,255,109,0));
      filter:blur(25px);
      pointer-events:none;
      animation:pulseGlow 3.4s ease-in-out infinite;
    }
    @keyframes pulseGlow{
      0%,100%{opacity:.2; transform:scale(1);}
      50%{opacity:.6; transform:scale(1.05);}
    }
    @keyframes fadeUp{
      from{opacity:0; transform:translateY(12px);}
      to{opacity:1; transform:translateY(0);}
    }
    @keyframes fadeInRight{
      from{opacity:0; transform:translateX(10px);}
      to{opacity:1; transform:translateX(0);}
    }

    /* SECTIONS */
    section{padding: clamp(48px, 9vw, 110px) clamp(16px, 5vw, 28px); max-width:1200px; margin-inline:auto}
    h2{font-family:Orbitron, sans-serif; color:var(--acid); margin:.25rem 0 1rem; font-size: clamp(26px, 3.2vw, 42px)}
    .lead{color:#c7f6dd; max-width:880px}

    /* PRICING (3 cards) */
    .pricing-row{
      display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));
      gap:18px; margin-top:26px;
    }
    .price-card{
      background:radial-gradient(circle at 10% 10%, rgba(18,255,109,.12), rgba(0,0,0,0)) , rgba(4,14,8,.85);
      border:1px solid rgba(18,255,109,.25);
      border-radius:18px;
      padding:20px 20px 22px;
      display:flex; flex-direction:column; gap:12px;
      box-shadow:0 14px 50px rgba(0,0,0,.25);
    }
    .price-title{font-weight:700; font-size:1.15rem}
    .price-num{font-size:2.6rem; font-weight:800; color:var(--acid); line-height:1; display:flex; align-items:baseline; gap:6px}
    .price-num small{font-size:.65rem; color:var(--muted); font-weight:600}
    .feat-list{list-style:none; padding:0; margin:4px 0 0; display:flex; flex-direction:column; gap:6px}
    .feat-list li{display:flex; gap:8px; align-items:flex-start; color:#d5ffe3; font-size:.9rem}
    .feat-list li:before{content:""; width:6px; height:6px; border-radius:999px; background:var(--acid); margin-top:7px; flex:0 0 6px;}
    .price-cta{
      margin-top:auto;
      display:inline-flex; align-items:center; justify-content:center;
      gap:6px; background:var(--acid); color:#001a0e;
      padding:11px 14px; border-radius:12px; font-weight:700; text-decoration:none;
    }
    .badge-pill{
      align-self:flex-end;
      background:rgba(196,255,222,.12);
      color:var(--fg);
      border:1px solid rgba(196,255,222,.22);
      border-radius:999px;
      padding:3px 11px;
      font-size:.65rem;
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    /* TOOLS (full-screen style) */
    .tools-wrap{
      max-width:1300px;
      margin:0 auto 90px;
      background: radial-gradient(circle at top, rgba(18,255,109,.07), rgba(0,0,0,0)) , rgba(2,8,4,.9);
      border:1px solid rgba(18,255,109,.15);
      border-radius:24px;
      padding:28px 28px 32px;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
    }
    .tools-headline{
      display:flex; align-items:center; justify-content:space-between; gap:14px; margin-bottom:18px;
    }
    .tools-input-row{
      display:flex; gap:14px; flex-wrap:wrap;
    }
    .tools-input{
      flex:1;
      min-width:240px;
      background:rgba(0,0,0,.15);
      border:1px solid rgba(156,245,201,.25);
      border-radius:16px;
      padding:13px 14px;
      color:var(--fg);
      font-size:.95rem;
      outline:none;
    }
    .tools-btn-big{
      background:var(--acid);
      border:none;
      border-radius:16px;
      padding:12px 20px;
      font-weight:700;
      color:#001a0e;
      display:inline-flex; align-items:center; gap:8px;
      transition:transform .1s ease;
    }
    .tools-small-btn{
      background:transparent;
      border:1px solid rgba(156,245,201,.15);
      border-radius:12px;
      color:var(--fg);
      padding:10px 14px;
      font-weight:600;
      display:inline-flex; align-items:center; gap:5px;
      transition:background .1s;
    }
    .tools-btn-big:hover{transform:translateY(-1px);}
    .tools-small-btn:hover{background:rgba(156,245,201,.08);}
    .progress-wrap{ margin-top:14px }
    .progress-bar{
      width:100%; height:10px; border-radius:999px;
      background:rgba(6,33,15,1);
      border:1px solid rgba(18,255,109,.08);
      overflow:hidden;
    }
    .progress-fill{
      height:100%; width:0%;
      background:var(--acid);
      transition:width .25s ease;
    }
    .status{ color:#cdeedb; font-size:13px; margin-top:6px }

    /* Tool result box */
    #tool-result .cardish{
      background:rgba(0,0,0,.15);
      border:1px solid rgba(18,255,109,.12);
      border-radius:18px;
      padding:18px;
      margin-top:18px;
    }

    /* HOW cards (reuse faq-grid layout) */
    .faq-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(260px, 1fr));
      gap:14px;
      margin-top:18px;
    }

    /* FAQ updated hacker style */
    details.faq-item{
      border:1px solid rgba(18,255,109,.12);
      border-radius:16px;
      padding:14px 16px;
      background:rgba(0,0,0,.08);
      overflow:hidden;
      transition:border .15s ease, box-shadow .15s ease, background .15s ease;
      position:relative;
    }
    details.faq-item[open]{
      border:1px solid rgba(18,255,109,.55);
      background:radial-gradient(circle at top, rgba(18,255,109,.12), rgba(0,0,0,0));
      box-shadow:0 0 26px rgba(18,255,109,.12);
    }
    details.faq-item summary{
      cursor:pointer; font-weight:700; color:#b8ffd7;
      list-style:none;
      display:flex;
      align-items:center;
      gap:10px;
      min-height:48px;
      user-select:none;
    }
    details.faq-item summary::-webkit-details-marker{display:none}
    .faq-arrow{
      width:22px;
      height:22px;
      border-radius:999px;
      border:1px solid rgba(18,255,109,.35);
      display:grid;
      place-items:center;
      color:var(--acid);
      font-size:12px;
      transition:transform .15s ease;
      background:rgba(0,0,0,.35);
      flex:0 0 22px;
    }
    details.faq-item[open] .faq-arrow{
      transform:rotate(90deg);
      background:rgba(18,255,109,.25);
    }
    details.faq-item p{
      color:#dff7ea;
      margin:0 0 12px 32px;
      line-height:1.5;
      font-size:.9rem;
      padding-right:4px;
    }

    footer{
      border-top:1px solid rgba(18,255,109,.05);
      background:linear-gradient(to bottom, #030a06, #000);
      padding:28px; text-align:center; color:var(--muted)
    }
    footer a{color:var(--acid); text-decoration:none}

    /* Reveal scroll animations */
    .reveal{opacity:0; transform:translateY(16px); transition:opacity .6s ease, transform .6s ease}
    .reveal.in{opacity:1; transform:none}

    @media (max-width:640px){
      .hero-actions{flex-direction:column; align-items:flex-start;}
      .tools-input-row{flex-direction:column; align-items:flex-start;}
      .tools-headline{flex-direction:column; align-items:flex-start;}
      .tools-wrap{border-radius:20px; padding:20px 15px 28px;}
    }
  </style>
</head>
<body>

  <!-- NAV -->
  <nav class="nav" id="nav">
    <div class="brand"><span class="logo"></span><span>DexTracker <b>Ai</b></span></div>
    <div class="burger" id="burger" aria-label="Toggle navigation" aria-expanded="false" aria-controls="navlinks">
      <span></span><span></span><span></span>
    </div>
    <div class="links" id="navlinks">
      <a href="#home" data-link>Home</a>
      <a href="#tools" data-link>Tools</a>
      <a href="#pricing" data-link>Pricing</a>
      <a href="#how" data-link>How It Works</a>
      <a href="#faq" data-link>FAQ</a>
    </div>
  </nav>

  <!-- HERO -->
  <header class="hero" id="home">
    <div class="hero-text">
      <p class="eyebrow">Creator Ops â€¢ Retention â€¢ Auto Clipping</p>
      <h1>Hacker-clean video AI for DexClanTV energy.</h1>
      <p>Paste a link, get clip candidates, see retention spikes, then send it right back into your iOS app.</p>
      <div class="hero-actions">
        <a class="btn-primary" href="#tools" data-link>Open tools â†’</a>
        <a class="btn-ghost" href="#pricing" data-link>View plans</a>
      </div>
    </div>
    <div class="hero-video">
      <div class="glow-ring"></div>
      <!-- âœ… drop your GitHub raw .mov here -->
      <!-- Example: https://raw.githubusercontent.com/USERNAME/REPO/main/Comp%201.mov -->
      <video
        src="https://github.com/dexclantv/dexclantv.github.io/raw/refs/heads/main/wow.mp4"
        autoplay
        muted
        loop
        playsinline
        poster=""
      ></video>
    </div>
  </header>

  <!-- TOOLS (full style) -->
  <section id="tools">
    <div class="tools-wrap">
      <div class="tools-headline">
        <div>
          <p class="eyebrow">Utilities</p>
          <h2 style="margin-bottom:6px">Tools</h2>
          <p class="lead" id="tools-copy">Paste a direct MP4 / M3U8 / YouTube link you own and weâ€™ll generate clip candidates.</p>
        </div>
        <button id="simulate-progress" class="tools-small-btn" type="button">Simulate Progress</button>
      </div>

      <div id="handoff" class="handoff" style="display:none">
        <span>ðŸŽ¯ <b>Received</b> <code id="handoff-id"></code> from app</span>
        <span class="x" onclick="this.parentElement.style.display='none'">âœ•</span>
      </div>

      <div class="tools-input-row" style="margin-bottom:12px">
        <input id="repurpose-input" class="tools-input" type="url" placeholder="https://www.youtube.com/watch?v=â€¦" />
        <button id="repurpose-run" class="tools-btn-big" type="button">Generate Clips</button>
        <button id="clear-input" class="tools-small-btn" type="button">Clear</button>
        <button id="simulate-result" class="tools-small-btn" type="button">Simulate Result</button>
      </div>

      <div class="tools-input-row" style="margin-bottom:6px">
        <button id="list-formats" class="tools-small-btn" type="button">List Formats</button>
        <select id="format-select" style="min-width:240px; flex:1; background:#0b140b; color:#e7ffe7; border:1px solid var(--line); border-radius:10px; padding:10px; display:none">
          <option value="">â€” choose a format â€”</option>
        </select>
        <button id="download-format" class="tools-small-btn" type="button" style="display:none">Download Selected</button>
        <button id="get-mp3" class="tools-small-btn" type="button" title="Extract audio as MP3">Get MP3</button>
      </div>

      <div class="progress-wrap" id="progress-wrap" style="display:none">
        <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
        <div id="status" class="status"></div>
      </div>

      <div id="tool-result" style="margin-top:16px; display:none"></div>
    </div>
  </section>

  <!-- HOW -->
  <section id="how">
    <p class="eyebrow">Workflow</p>
    <h2>Three steps. All gas, no brakes.</h2>
    <p class="lead">Same flow as your iOS app.</p>
    <div class="faq-grid">
      <div class="reveal cardish">
        <h3>1) Set intent</h3>
        <p>Tell DexTracker what youâ€™re doing today: upload, clip, or SEO checks.</p>
      </div>
      <div class="reveal cardish">
        <h3>2) Leverage AI</h3>
        <p>Script brainstormer, title simulator, and clip generator work together.</p>
      </div>
      <div class="reveal cardish">
        <h3>3) React fast</h3>
        <p>Spikes or dips? We flag it so you can swap title/thumbnail fast.</p>
      </div>
    </div>
  </section>

  <!-- PRICING -->
  <section id="pricing">
    <p class="eyebrow">Pricing</p>
    <h2>Three plans for where you are</h2>
    <p class="lead">Start light, grow to Pro, or hit us for team / multi-channel setups.</p>

    <div class="pricing-row">
      <!-- Starter -->
      <article class="price-card reveal">
        <h3 class="price-title">Starter</h3>
        <div class="price-num">$0 <small>/mo</small></div>
        <p>Test the tool, 1â€“2 clips/day, basic parsing.</p>
        <ul class="feat-list">
          <li>Tools page access</li>
          <li>Manual paste only</li>
          <li>Demo video support</li>
        </ul>
        <a href="#tools" class="price-cta">Start free</a>
      </article>

      <!-- Pro -->
      <article class="price-card reveal" style="border:1px solid rgba(18,255,109,.55); box-shadow:0 24px 65px rgba(0,255,149,.12);">
        <div class="badge-pill">Most used</div>
        <h3 class="price-title">Pro</h3>
        <div class="price-num">$9.99 <small>/mo</small></div>
        <p>Everything youâ€™ve been building in DexTracker (alerts, CTR helpers, reply queue).</p>
        <ul class="feat-list">
          <li>Auto handoff from iOS app</li>
          <li>Clip candidate generator</li>
          <li>Retention / spike suggestions</li>
          <li>SEO-aware script starter</li>
          <li>Comment reply queue (manual approve)</li>
          <li>5 Grok messages/day</li>
        </ul>
        <a href="#" class="price-cta" onclick="alert('Coming soon â€¢ App Store connect')">Get Pro</a>
      </article>

      <!-- Business -->
      <article class="price-card reveal">
        <h3 class="price-title">Business</h3>
        <div class="price-num">Letâ€™s talk</div>
        <p>Ideal for agencies, teams, or brands that want creator analytics in a private dashboard.</p>
        <ul class="feat-list">
          <li>Custom clip endpoints</li>
          <li>Team onboarding</li>
          <li>Priority support</li>
        </ul>
        <a href="mailto:dexclantv@gmail.com?subject=DexTracker%20Business" class="price-cta">Contact us â†’</a>
      </article>
    </div>
  </section>

  <!-- FAQ -->
  <section id="faq">
    <p class="eyebrow">FAQ</p>
    <h2>Quick answers</h2>
    <div class="faq-grid">
      <details class="reveal faq-item" open>
        <summary>
          <span class="faq-arrow">â€º</span>
          What is DexTracker?
        </summary>
        <p>Dex Tracker is an AI-powered assistant that helps you grow your YouTube channel by automating analytics, clipping, scripting, and trend research â€” same energy as the iOS app.</p>
      </details>
      <details class="reveal faq-item" open>
        <summary>
          <span class="faq-arrow">â€º</span>
          How does auto-clipping work?
        </summary>
        <p>We detect high-retention moments in your videos and let you export them as ready-to-post Shorts, Reels, or TikToks.</p>
      </details>
      <details class="reveal faq-item">
        <summary>
          <span class="faq-arrow">â€º</span>
          What does the SEO simulator do?
        </summary>
        <p>It generates optimized titles and compares their CTR potential using emotional triggers, curiosity scores, and historic patterns.</p>
      </details>
      <details class="reveal faq-item">
        <summary>
          <span class="faq-arrow">â€º</span>
          Can I export clips to CapCut?
        </summary>
        <p>Yes â€” export the MP4 from the tools page, then import to CapCut, iMovie, or your iPhone camera roll.</p>
      </details>
      <details class="reveal faq-item">
        <summary>
          <span class="faq-arrow">â€º</span>
          Is there a free trial?
        </summary>
        <p>Yep. Just like the app: 7-day free trial, then your plan.</p>
      </details>
      <details class="reveal faq-item">
        <summary>
          <span class="faq-arrow">â€º</span>
          Will Dex Tracker post my stats to Discord?
        </summary>
        <p>Only if you enable it. By default, nothing is posted anywhere.</p>
      </details>
    </div>
  </section>

  <footer>
    <div>Â© 2025 DexTracker â€¢ <a href="https://dexclantv.github.io/landing.html" target="_blank" rel="noopener">GitHub Pages</a></div>
    <div style="margin-top:6px">Follow: <a href="https://www.instagram.com/Perry.Glo" target="_blank" rel="noopener">Instagram</a> â€¢ <a href="https://twitter.com/DexClanTv" target="_blank" rel="noopener">Twitter</a> â€¢ <a href="https://www.youtube.com/@DexClanTv" target="_blank" rel="noopener">YouTube</a></div>
    <div style="margin-top:10px; font-size:12px; color:#9cf5c9">Privacy: No tracking pixels. We only use the URLs you provide to generate results.</div>
  </footer>

  <!-- Bridge helpers (load minimal.js if you have it; safe without) -->
  <script src="minimal.js" defer></script>

  <script>
    // mobile nav
    const burger = document.getElementById('burger');
    const links = document.getElementById('navlinks');
    burger?.addEventListener('click', () => {
      const open = links.classList.toggle('open');
      burger.setAttribute('aria-expanded', open ? 'true':'false');
    });

    // Smooth scroll with offset
    function scrollToWithOffset(id){
      const el = document.querySelector(id);
      const nav = document.getElementById('nav');
      if(!el || !nav) return;
      const y = el.getBoundingClientRect().top + window.scrollY - (nav.offsetHeight + 8);
      window.scrollTo({top:y, behavior:'smooth'});
    }
    document.querySelectorAll('[data-link]')?.forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        scrollToWithOffset(a.getAttribute('href'));
        links.classList.remove('open');
      });
    });

    // scroll reveal
    const observer = new IntersectionObserver((entries)=>{
      entries.forEach(({target, isIntersecting})=>{
        if(isIntersecting){ target.classList.add('in'); observer.unobserve(target); }
      });
    }, {threshold:.16});
    document.querySelectorAll('.reveal').forEach(el=>observer.observe(el));

    // ====== TOOL LOGIC ======
    // fallback bridge (safe)
    window.sendProgress = window.sendProgress || function (p) {
      try { window.webkit?.messageHandlers?.clipper?.postMessage({type:'progress', value:p}); } catch {}
    };
    window.sendResult = window.sendResult || function (url) {
      try { window.webkit?.messageHandlers?.clipper?.postMessage({type:'result', url}); } catch {}
    };

    const API_BASE = new URLSearchParams(location.search).get("api") || "https://dextracker-clips.fly.dev";

    function showHandoff(id){
      const b = document.getElementById('handoff');
      const code = document.getElementById('handoff-id');
      if (b && code){ code.textContent = id; b.style.display = 'flex'; }
    }
    function setInput(raw){
      const input = document.getElementById('repurpose-input');
      if (!input) return;
      const val = (raw||"").trim();
      if (!val) return;
      input.value = val;
      try { localStorage.setItem('dex_last_url_or_id', val); } catch {}
      showHandoff(val);
    }
    function toWatchUrlFromId(id){
      const clean = (id||"").trim().replace(/^vid=/,'').replace(/^#/,'');
      if(!clean) return "";
      return `https://www.youtube.com/watch?v=${encodeURIComponent(clean)}`;
    }
    window.dexSetUrl = function(url){ setInput(url); };
    window.dexSetVideoId = function(id){ setInput(toWatchUrlFromId(id) || id); };

    window.addEventListener('message', (e)=>{
      try{
        const d = e?.data || {};
        if (d.type === 'dex-url' && d.url) return window.dexSetUrl(d.url);
        if (d.type === 'dex-video-id' && d.id) return window.dexSetVideoId(d.id);
      }catch{}
    });

    // bootstrap auto-paste + auto-scroll to tools
    (function bootstrap(){
      try{
        const qs = new URLSearchParams(location.search);
        const urlQ = qs.get('url');
        const vidQ = qs.get('videoId') || qs.get('v');
        const stored = localStorage.getItem('dex_last_url_or_id') || '';
        if (urlQ) setInput(decodeURIComponent(urlQ));
        else if (vidQ) setInput(toWatchUrlFromId(decodeURIComponent(vidQ)));
        else if (stored) setInput(stored);
        // go straight to tools
        scrollToWithOffset('#tools');
      }catch{}
    })();

    function showProgressUI(show){
      const wrap = document.getElementById('progress-wrap');
      if(!wrap) return;
      wrap.style.display = show ? 'block' : 'none';
    }
    function setProgress(pct, text){
      const fill = document.getElementById('progress-fill');
      const status = document.getElementById('status');
      if(fill){ fill.style.width = Math.max(0, Math.min(100, pct)) + '%'; }
      if(status){ status.textContent = text || ''; }
    }
    function bindTap(id, handler){
      const el = document.getElementById(id);
      if(!el) return;
      let firing = false;
      const wrap = (e) => {
        if (firing) return;
        firing = true;
        try { handler(e); } finally { setTimeout(()=>firing=false, 140); }
      };
      el.addEventListener('click', wrap);
      el.addEventListener('touchend', wrap, { passive: true });
    }

    // format parser (same as before)
    function parseFormats(text){
      const lines = (text || "").split("\n");
      const rows = [];
      for (const ln of lines){
        const m = ln.match(/^\s*([0-9a-zA-Z.-]+)\s+(\S+)\s+(.+?)\s{2,}(.+)?$/);
        if (!m) continue;
        const id = m[1];
        const ext = m[2];
        const col3 = m[3];
        const rest = (m[4]||"").trim();
        let res = "", fps = "", size="";
        if (/audio only/i.test(col3)){ res = "audio"; }
        else {
          const r1 = col3.match(/(\d{3,4}x\d{3,4})/);
          const r2 = col3.match(/(\d{3,4}p)/i);
          res = r1 ? r1[1] : (r2 ? r2[1] : col3.trim());
        }
        const fpsm = (rest.match(/(\d{2,3})fps/i) || []);
        fps = fpsm[1] || "";
        const sz = rest.match(/(\d+(?:\.\d+)?[MK]B)/i);
        if (sz) size = sz[1];
        rows.push({ id, ext, res, fps, size, note: rest });
      }
      const seen = new Set();
      return rows.filter(r=>{
        const key = r.id+"|"+r.ext+"|"+r.res+"|"+r.fps;
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });
    }
    function fillFormatSelect(rows){
      const sel = document.getElementById("format-select");
      const btn = document.getElementById("download-format");
      if (!sel || !btn) return;
      sel.innerHTML = `<option value="">â€” choose a format â€”</option>`;
      rows.forEach(r=>{
        const isAudio = (r.res || "").toLowerCase() === "audio" || /audio only/i.test(r.note||"");
        const label = [
          r.id,
          r.ext?.toUpperCase(),
          isAudio ? "AUDIO" : (r.res || ""),
          r.fps ? `${r.fps}fps` : "",
          r.size ? `(${r.size})` : "",
        ].filter(Boolean).join(" Â· ");
        const opt = document.createElement("option");
        opt.value = r.id;
        opt.textContent = label;
        opt.dataset.isAudio = isAudio ? "1" : "0";
        sel.appendChild(opt);
      });
      sel.style.display = "block";
      btn.style.display = "inline-flex";
    }

    async function pollJob(jobId){
      return new Promise((resolve, reject)=>{
        let last = 10;
        async function tick(){
          try{
            const r = await fetch(`${API_BASE}/api/jobs/${jobId}`);
            const data = await r.json();
            if (data.status === "running"){
              last = Math.max(last, Math.round((data.progress||0)*100));
              setProgress(last, `Processingâ€¦ ${last}%`);
              setTimeout(tick, 900);
            } else if (data.status === "done" && data.url){
              setProgress(100, "Finished!");
              resolve(`${API_BASE}${data.url}`);
            } else if (data.status === "error"){
              reject(new Error(data.error || "merge error"));
            } else {
              setTimeout(tick, 1200);
            }
          } catch(err) {
            console.error(err);
            setTimeout(tick, 1200);
          }
        }
        tick();
      });
    }

    // BUTTONS
    bindTap('repurpose-run', async () => {
      const input = document.getElementById('repurpose-input');
      const val = input?.value?.trim();
      if(!val){ alert('Paste a direct .mp4/.m3u8 URL or a YouTube link you own.'); return; }

      showProgressUI(true);
      setProgress(5, 'Contacting Clip APIâ€¦');
      sendProgress(0.05);

      try {
        const r = await fetch(`${API_BASE}/api/clip`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url: val })
        });

        if (r.status === 403) throw new Error(await r.text());

        if (r.status === 409) {
          setProgress(10, 'No single stream. Mergingâ€¦');
          const r2 = await fetch(`${API_BASE}/api/jobs`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: val })
          });
          if (!r2.ok) throw new Error(await r2.text() || `HTTP ${r2.status}`);
          const { jobId } = await r2.json();
          const fileUrl = await pollJob(jobId);
          const el = document.getElementById('tool-result');
          el.style.display = 'block';
          el.innerHTML = `<div class="cardish"><h3>Result</h3><p><a href="${fileUrl}" target="_blank" rel="noopener">Download MP4</a></p></div>`;
          return;
        }

        if (!r.ok) throw new Error(await r.text() || `HTTP ${r.status}`);

        const data = await r.json();
        if (!data.directUrl) throw new Error('No directUrl returned');
        setProgress(20, 'Fetching mediaâ€¦');
        sendResult(data.directUrl);

        const result = document.getElementById('tool-result');
        result.style.display = 'block';
        result.innerHTML = `<div class="cardish">
          <h3>Result</h3>
          <p>Sent final clip URL to the app.</p>
          <p>Fallback link: <a href="${data.directUrl}" target="_blank" rel="noopener">open</a></p>
        </div>`;
        setProgress(100, 'Finished!');
        sendProgress(1.0);
      } catch (e) {
        console.error(e);
        setProgress(0, 'Error: ' + (e?.message || e));
        alert('Clip API failed: ' + (e?.message || e));
        sendProgress(0.0);
      }
    });

    bindTap('clear-input', ()=>{
      const input = document.getElementById('repurpose-input');
      if (input) input.value = '';
      const res = document.getElementById('tool-result');
      if (res) res.style.display = 'none';
      showProgressUI(false);
    });

    bindTap('simulate-progress', ()=>{
      showProgressUI(true);
      let n = 0;
      const tick = () => {
        n += 12;
        setProgress(Math.min(n, 100), 'Simulatingâ€¦ ' + Math.min(n,100) + '%');
        if (n < 100) setTimeout(tick, 160);
      };
      tick();
    });

    bindTap('simulate-result', ()=>{
      const el = document.getElementById('tool-result');
      el.style.display = 'block';
      el.innerHTML = `<div class="cardish">
        <h3>Result</h3>
        <p>Sent final clip URL to the app.</p>
        <p>Fallback link: <a href="https://example.com/demo.mp4" target="_blank" rel="noopener">open</a></p>
      </div>`;
      setProgress(100, 'Finished!');
    });

    bindTap('list-formats', async ()=>{
      const input = document.getElementById('repurpose-input');
      const val = input?.value?.trim();
      if(!val){ return alert("Paste a URL first."); }
      showProgressUI(true);
      setProgress(8, "Listing formatsâ€¦");
      try{
        const r = await fetch(`${API_BASE}/api/vb/formats`, {
          method: "POST",
          headers: {"content-type":"application/json"},
          body: JSON.stringify({ url: val })
        });
        if (!r.ok) throw new Error(await r.text() || `HTTP ${r.status}`);
        const data = await r.json();
        const rows = parseFormats(data.formats || "");
        if (!rows.length) throw new Error("No formats found.");
        fillFormatSelect(rows);
        setProgress(12, "Choose a format then Download Selected");
      }catch(e){
        console.error(e);
        alert("Formats failed: " + (e.message || e));
        setProgress(0, "Error");
      }
    });

    bindTap('download-format', async ()=>{
      const input = document.getElementById('repurpose-input');
      const url = input?.value?.trim();
      const sel = document.getElementById('format-select');
      let format = sel?.value?.trim();
      if (!url) return alert("Paste a URL first.");
      if (!format) return alert("Choose a format first.");

      const isAudioOnly = sel.options[sel.selectedIndex]?.dataset?.isAudio === "1";
      if (!isAudioOnly && !format.includes("+")) {
        format = `${format}+bestaudio/b`;
      }

      showProgressUI(true);
      setProgress(10, `Downloading ${format}â€¦`);

      try{
        const r = await fetch(`${API_BASE}/api/clip`, {
          method: "POST",
          headers: {"content-type":"application/json"},
          body: JSON.stringify({ url, format })
        });

        if (r.status === 403) throw new Error(await r.text());

        if (r.status === 409) {
          const r2 = await fetch(`${API_BASE}/api/jobs`, {
            method: "POST",
            headers: {"content-type":"application/json"},
            body: JSON.stringify({ url, format })
          });
          if (!r2.ok) throw new Error(await r2.text() || `HTTP ${r2.status}`);
          const { jobId } = await r2.json();
          const fileUrl = await pollJob(jobId);
          const el = document.getElementById('tool-result');
          el.style.display = 'block';
          el.innerHTML = `<div class="cardish"><h3>Result</h3><p><a href="${fileUrl}" target="_blank" rel="noopener">Download MP4</a></p></div>`;
          return;
        }

        if (!r.ok) throw new Error(await r.text() || `HTTP ${r.status}`);
        const data = await r.json();
        if (!data.directUrl) throw new Error("No directUrl returned");
        setProgress(20, "Fetching mediaâ€¦");
        sendResult(data.directUrl);
        const el = document.getElementById('tool-result');
        el.style.display = 'block';
        el.innerHTML = `<div class="cardish"><h3>Result</h3>
          <p>Sent final clip URL to the app. Fallback: <a href="${data.directUrl}" target="_blank" rel="noopener">open</a></p></div>`;
        setProgress(100, "Finished!");
      }catch(e){
        console.error(e);
        alert("Download failed: " + (e.message || e));
        setProgress(0, "Error");
      }
    });

    bindTap("get-mp3", async ()=>{
      const input = document.getElementById('repurpose-input');
      const url = input?.value?.trim();
      if(!url) return alert("Paste a URL first.");
      showProgressUI(true);
      setProgress(10, "Extracting audioâ€¦");
      try{
        const r = await fetch(`${API_BASE}/api/mp3`, {
          method: "POST",
          headers: {"content-type":"application/json"},
          body: JSON.stringify({ url })
        });
        if (!r.ok) throw new Error(await r.text() || `HTTP ${r.status}`);
        const { jobId } = await r.json();
        const fileUrl = await pollJob(jobId);
        window.open(fileUrl, "_blank", "noopener");
      }catch(e){
        console.error(e);
        alert("MP3 API failed: " + (e.message || e));
        setProgress(0, "Error");
      }
    });

  </script>
</body>
</html>
